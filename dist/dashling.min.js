!function(){function e(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function t(e,t){return function(){return t.apply(e,arguments)}}function n(e,t){(!t||t.logToConsole)&&console.log(e)}function s(e,t,n){var s=e.getElementsByTagName(t)[0],i=s?s.childNodes[0]:null;return i?i.nodeValue:n}function a(e){var t=0,n=e.substring("2"),s=n.indexOf("H");return s>-1&&(t+=60*Number(n.substring(0,s))*60,n=n.substring(s+1)),s=n.indexOf("M"),s>-1&&(t+=60*Number(n.substring(0,s)),n=n.substring(s+1)),s=n.indexOf("S"),s>-1&&(t+=Number(n.substring(0,s))),t}function r(e,t,n){var s=e.average||0;for(e.average=s+(t-s)/(e.length+1),e.push(t);e.length>n;)o(e)}function o(e){var t=e.shift(),n=e.average;e.average=n+(n-t)/e.length}var d={throttle:function(e,t,n,s,i){var a=this;a._throttleIds||(a._throttleIds={}),s&&a.clearThrottle(t),a._throttleIds[t]||(a._throttleIds[t]=setTimeout(function(){i||e(),delete a._throttleIds[t]},n),i&&(i=!1,e()))},clearThrottle:function(e){this._throttleIds&&(clearTimeout(this._throttleIds[e]),delete this._throttleIds[e])},clearAllThrottles:function(){if(this._throttleIds){for(var e in this._throttleIds)clearTimeout(this._throttleIds[e]);this._throttleIds=null}}},l={addEventListener:function(e,t){this.__events=this.__events||{};var n=this.__events[e]=this.__events[e]||[];n.push(t)},removeEventListener:function(e,t){var n=this.__events&&this.__events[e];if(n){var s=n.indexOf(t);s>-1&&n.splice(s,1)}},removeAllEventListeners:function(){this.__events=null},raiseEvent:function(e){for(var t=this.__events&&this.__events[e],n=0;t&&n<t.length&&t[n].apply(this,Array.prototype.slice.apply(arguments,[1]))!==!1;n++);}},u={sessionStateChange:"sessionstatechange",download:"download"},m={manifestDownload:"manifestDownload",initSegmentDownload:"initSegmentDownload",mediaSegmentDownload:"mediaSegmentDownload",manifestParse:"manifestParse",sourceBufferInit:"sourceBufferInit",sourceBufferAppendException:"sourceBufferAppendException",sourceBufferAppendMissing:"sourceBufferAppendMissing"},g={error:-1,idle:0,initializing:1,buffering:2,playing:4,paused:5},_={error:-1,idle:0,downloading:1,downloaded:2,appending:3,appended:4};window.Dashling=function(){this.settings=e({},Dashling.Settings)},e(Dashling,{Event:u,SessionState:g,FragmentState:_,Error:m}),Dashling.prototype={_streamController:null,_sessionIndex:0,state:g.idle,lastError:null,startTime:null,timeAtFirstCanPlay:null,load:function(e,t){var n=this;n.reset(),n.startTime=(new Date).getTime(),n._setState(g.initializing),n._videoElement=e,n._initializeMediaSource(e),n._initializeManifest(t)},dispose:function(){this.isDisposed=!0,this.reset()},reset:function(){var e=this;if(e.startTime=null,e.timeAtFirstCanPlay=null,e.lastError=null,e._streamController&&(e._streamController.dispose(),e._streamController=null),e._parser&&(e._parser.dispose(),e._parser=null),e._videoElement){e.settings.manifest=null;try{e._videoElement.pause()}catch(t){}e._videoElement=null}e.videoElement=null,e._mediaSource=null,e._setState(g.idle)},getRemainingBuffer:function(){return this._streamController?this._streamController.getRemainingBuffer():0},getBufferRate:function(){return this._streamController?this._streamController.getBufferRate():0},getPlayingQuality:function(e){return this._streamController?this._streamController.getPlayingQuality(e):this.settings[e]},getBufferingQuality:function(e){return this._streamController?this._streamController.getBufferingQuality(e):this.settings[e]},getMaxQuality:function(e){var t=this.settings.manifest?this.settings.manifest.streams[e]:null;return t?t.qualities.length-1:0},_setState:function(e,t,n){this.isDisposed||this.state==e||(this.state=e,this.lastError=t?t+" "+(n?"("+n+")":""):null,e==g.error&&this._streamController&&this._streamController.dispose(),this.timeAtFirstCanPlay||e!=g.playing&&e!=g.paused||(this.timeAtFirstCanPlay=(new Date).getTime()-this.startTime),this.raiseEvent(u.sessionStateChange,e,t,n))},_initializeMediaSource:function(e){function t(){n.removeEventListener("sourceopen",t),s._sessionIndex==i&&(s._mediaSource=n,s._tryStart())}var n,s=this,i=s._sessionIndex;s.raiseEvent(u.initMediaSourceStart);try{n=new MediaSource}catch(a){s._setState(g.error,Dashling.Error.mediaSourceInit)}n&&(n.addEventListener("sourceopen",t,!1),e.src=window.URL.createObjectURL(n))},_initializeManifest:function(e){function t(e){s._loadIndex==i&&s.state!=g.error&&(s.settings.manifest=e,s._tryStart())}function n(e,t){s._loadIndex==i&&s._setState(g.error,e,t)}var s=this,i=s._loadIndex;s.settings.manifest?t(s.settings.manifest):(s._parser=new Dashling.ManifestParser(s.settings),s._parser.addEventListener(u.download,function(e){s.raiseEvent(Dashling.Event.download,e)}),this._parser.parse(e,t,n))},_tryStart:function(){var e=this;e.state!=g.error&&e._mediaSource&&e.settings.manifest&&(e._mediaSource.duration=e.settings.manifest.mediaDuration,e._streamController=new Dashling.StreamController(e._videoElement,e._mediaSource,e.settings),e._streamController.addEventListener(u.download,function(t){e.raiseEvent(Dashling.Event.download,t)}),e._streamController.addEventListener(u.sessionStateChange,function(t,n,s){e._setState(t,n,s)}),e._streamController.start())}},e(Dashling.prototype,l),Dashling.Settings={manifest:null,startTime:0,isABREnabled:!0,isRBREnabled:!1,targetQuality:{audio:2,video:2},shouldAutoPlay:!0,logToConsole:!1,safeBufferSeconds:12,maxBufferSeconds:119.5,maxConcurrentRequests:{audio:4,video:6},maxSegmentLeadCount:{audio:1,video:5},defaultBandwidth:520,requestTimeout:3e4,maxRetries:3,delaysBetweenRetries:[200,1500,3e3],requestCacheThreshold:80,baseUrlOverride:null},Dashling.ManifestParser=function(e){var t=this;t._settings=e,t._requestManager=new Dashling.RequestManager(!1,e),t._requestManager.addEventListener(u.download,function(e){t.raiseEvent(u.download,e)})},Dashling.ManifestParser.prototype={_parseIndex:0,dispose:function(){this._requestManager&&(this._requestManager.dispose(),this._requestManager=null)},parse:function(e,t,n){function s(s){if(a._parseIndex==r){var i;try{i=a._parseManifest(s.data,e),i.request=s}catch(o){n(m.manifestParse,o)}i&&t(i)}}function i(){a._parseIndex==r&&n(m.manifestDownload,o.statusCode)}var a=this,r=++a._parseIndex,o={url:e,requestType:"manifest",onSuccess:s,onError:i};this._requestManager.load(o)},_parseManifest:function(e,t){var n,i={},r=new DOMParser,o=r.parseFromString(e,"text/xml");i.baseUrl=this._settings.baseUrlOverride||s(o,"BaseURL",""),t&&!i.baseUrl&&(i.baseUrl=t.substring(0,t.lastIndexOf("/")+1)),i.mediaDuration=a(o.documentElement.getAttribute("mediaPresentationDuration")),i.streams={};for(var d=o.querySelectorAll("AdaptationSet"),l=0;l<d.length;l++){var u=d[l];if(u){var m=u.getAttribute("contentType");m||(m=u.getAttribute("mimeType").split("/")[0]);for(var g=u.querySelectorAll("Representation"),_=u.querySelector("SegmentTemplate"),f=i.streams[m]={streamType:m,mimeType:u.getAttribute("mimeType"),codecs:u.getAttribute("codecs")||u.querySelector("[codecs]").getAttribute("codecs"),initUrlFormat:_.getAttribute("initialization"),fragUrlFormat:_.getAttribute("media"),qualities:[],timeline:[]},h=_.getAttribute("timescale"),c=_.getAttribute("duration"),p=c/h,v=0;v<g.length;v++){var y=g[v],S={id:y.getAttribute("id"),bandwidth:y.getAttribute("bandwidth")};y.getAttribute("height")&&(S.width=Number(y.getAttribute("width")),S.height=Number(y.getAttribute("height"))),f.qualities.push(S)}var T=1;_.hasAttribute("startNumber")&&(T=parseInt(_.getAttribute("startNumber")));var I,q,E=u.querySelectorAll("S");if(E.length)for(var x=0;x<E.length;x++){var b=E[x],A=Number(b.getAttribute("r"))||0;q=Number(b.getAttribute("d"));var D=0;for(n=0;A>=n;n++)I=D/h,f.timeline.push({serverSegmentIndex:Math.floor(i.mediaDuration/I),start:D,startSeconds:I,length:q,lengthSeconds:q/h}),D+=q}else for(var M=Math.ceil(i.mediaDuration/p),w=0;M>w;w++){var R=w+T;I=w*p,q=Math.min(p,i.mediaDuration-I),f.timeline.push({serverSegmentIndex:R,start:I*h,startSeconds:I,length:q*h,lengthSeconds:q})}}}return i}},e(Dashling.ManifestParser.prototype,l);var f=.06,h=.5;Dashling.StreamController=function(e,n,s){var i=this;if(i._onVideoSeeking=t(i,i._onVideoSeeking),i._onVideoError=t(i,i._onVideoError),i._onPauseStateChange=t(i,i._onPauseStateChange),i._onVideoEnded=t(i,i._onVideoEnded),i._appendNextFragment=t(i,i._appendNextFragment),i._onThrottledSeek=t(i,i._onThrottledSeek),i._onVideoRateChange=t(i,i._onVideoRateChange),i._mediaSource=n,i._settings=s,i._bufferRate=[],i._appendedSeconds=0,i._requestTimerIds=[0,0],i._intializeVideoElement(e),i._initializeStreams(e,n,s),i._streams.length&&s&&s.startTime){var a=i._streams[0],r=a.fragments[0].time.lengthSeconds;this._appendIndex=Math.max(0,Math.min(a.fragments.length-1,Math.floor((s.startTime-h)/r)))}},Dashling.StreamController.prototype={_nextStreamIndex:0,_appendIndex:0,_audioDownloadIndex:0,_videoDownloadIndex:0,_simultaneousDownloadsPerStream:2,_maxSegmentsAhead:2,_nextRequestTimerId:0,_seekingTimerId:0,_stalls:0,_lastCurrentTime:0,_lastTimeBeforeSeek:0,_startTime:0,dispose:function(){var e=this;e.isDisposed=!0,e._adjustPlaybackMonitor(!1),e._videoElement&&(e._videoElement.removeEventListener("seeking",e._onVideoSeeking),e._videoElement.removeEventListener("error",e._onVideoError),e._videoElement.removeEventListener("play",e._onPauseStateChange),e._videoElement.removeEventListener("pause",e._onPauseStateChange),e._videoElement.removeEventListener("ended",e._onVideoEnded),e._videoElement.removeEventListener("ratechange",e._onVideoRateChange),e._videoElement=null);for(var t=0;e._streams&&t<e._streams.length;t++)e._streams[t].dispose();e._requestTimerIds[0]&&(clearTimeout(e._requestTimerIds[0]),e._requestTimerIds[0]=0),e._requestTimerIds[1]&&(clearTimeout(e._requestTimerIds[1]),e._requestTimerIds[1]=1),e._seekingTimerId&&(clearTimeout(e._seekingTimerId),e._seekingTimerId=0),e._mediaSource=null,e.removeAllEventListeners()},start:function(){this._startTime=(new Date).getTime(),this._setCanPlay(!1),this._loadNextFragment(),this._adjustPlaybackMonitor(!0)},getPlayingQuality:function(e){var t=0;if(!this.isDisposed)for(var n=0;n<this._streams.length;n++){var s=this._streams[n];if(s.streamType==e){var i=this._videoElement.currentTime,a=Math.min(s.fragments.length-1,Math.floor(i/s.fragments[0].time.lengthSeconds));t=s.fragments[a].qualityIndex,t=t>=0?t:s.qualityIndex;break}}return t},getBufferingQuality:function(e){var t=0;if(!this.isDisposed)for(var n=0;n<this._streams.length;n++){var s=this._streams[n];if(s.streamType==e){t=s.qualityIndex;break}}return t},getBufferRate:function(){return this._bufferRate.average||0},getRemainingBuffer:function(e){var t=this,n=0;if(!t.isDisposed){var s=(t._settings.startTime||t._videoElement.currentTime)+(e||0),i=t._videoElement.buffered;!s&&i.length>0&&i.start(0)<1&&(s=i.start(0));for(var a=0;a<i.length;a++)if(s>=i.start(a)&&s<=i.end(a)){for(var r=i.end(a);++a<i.length&&i.start(a)-r<f;)r=i.end(a);n=r-s;break}}return n},getTimeUntilUnderrun:function(e){var t=Number.MAX_VALUE,n=this;if(!n.isDisposed){var s=n._settings.startTime||Math.max(.5,n._videoElement.currentTime),i=n._settings.manifest.mediaDuration-s-.5,a=this.getRemainingBuffer(e),r=this.getBufferRate(),o=a/this._settings.safeBufferSeconds;if(o=Math.min(1,Math.max(0,o)),i>a){var d=a*r;t=a+o*d,(t>i||t>.5*n._settings.maxBufferSeconds)&&(t=Number.MAX_VALUE)}}return t},_intializeVideoElement:function(e){var t=this;e&&(t._videoElement=e,e.addEventListener("seeking",t._onVideoSeeking),e.addEventListener("error",t._onVideoError),e.addEventListener("play",t._onPauseStateChange),e.addEventListener("pause",t._onPauseStateChange),e.addEventListener("ended",t._onVideoEnded),e.addEventListener("ratechange",t._onVideoRateChange))},_initializeStreams:function(e,t,n){function s(e){r.raiseEvent(u.download,e)}function a(e,t,n){r.raiseEvent(u.sessionStateChange,e,t,n)}var r=this,o=n&&n.manifest&&n.manifest.streams?n.manifest.streams:null;for(r._streams=[],o&&(o.audio&&r._streams.push(new Dashling.Stream("audio",t,e,n)),o.video&&r._streams.push(new Dashling.Stream("video",t,e,n))),i=0;i<r._streams.length;i++)stream=r._streams[i],stream.addEventListener(u.download,s),stream.addEventListener(u.sessionStateChange,a),stream.initialize()},_loadNextFragment:function(){function e(e,n){t.isDisposed||(t._requestTimerIds[e]&&clearTimeout(t._requestTimerIds[e]),t._requestTimerIds[e]=setTimeout(function(){t._requestTimerIds[e]=0,t._loadNextFragment()},n))}var t=this;if(!t.isDisposed){for(var n=t._getDownloadCandidates(),s=0;s<n.length;s++)for(var i=n[s],a=t._streams[s],r=0;r<i.length;r++){var o=i[r],d=(a.fragments[o],a.fragments[o-1]),l=d&&d.activeRequest&&d.activeRequest.state==_.downloading?d.activeRequest:null,u=a.getRequestStaggerTime(),m=l?(new Date).getTime()-l.startTime:0;if(l&&!(m>=u)){e(s,u-m);break}a.load(o,this._appendNextFragment)}n.isAtMax&&e(0,300)}},_appendNextFragment:function(e){var t,n,s=this,i=this._streams;if(!s.isDisposed){var a=s._settings.startTime||s._videoElement.currentTime;if(i&&i.length&&s._mediaSource&&"closed"!=s._mediaSource.readyState){for(;s._appendIndex<i[0].fragments.length;){var o=!0,d=!0;for(n=0;n<i.length;n++)t=i[n],o&=t.canAppend(s._appendIndex),d&=t.fragments[s._appendIndex].state==_.appended&&!t.isMissing(s._appendIndex,a);if(o)for(d=!1,n=0;n<i.length;n++)t=i[n],t.append(s._appendIndex,s._appendNextFragment),d&=t.fragments[s._appendIndex].state==_.appended;if(!d)break;var l=s._streams[0].fragments[s._appendIndex];if(!l.activeRequest._hasUpdatedBufferRate){l.activeRequest._hasUpdatedBufferRate=!0,s._appendedSeconds+=l.time.lengthSeconds;var u=(new Date).getTime(),m=(u-this._startTime)/1e3;r(s._bufferRate,s._appendedSeconds/(m||.1),3)}if(s._appendIndex++,s._settings.startTime)try{s._videoElement.currentTime=s._settings.startTime,s._settings.startTime=0}catch(g){}s._checkCanPlay()}s._appendIndex==i[0].fragments.length&&"open"==s._mediaSource.readyState&&s._mediaSource.endOfStream(),s._loadNextFragment()}}},_adjustPlaybackMonitor:function(e){var t=this;!e&&t._playbackMonitorId?(clearInterval(t._playbackMonitorId),t._playbackMonitorId=0):e&&!t._playbackMonitorId&&(t._playbackMonitorId=setInterval(function(){t._checkCanPlay()},200))},_checkCanPlay:function(){var e=this,t=e.getTimeUntilUnderrun(),n=.5;this._lastCurrentTime=e._videoElement.currentTime,e._canPlay&&.1>t&&!e._timeAtStall&&(e._timeAtStall=this._lastCurrentTime,setTimeout(function(){var t=e._timeAtStall;e._timeAtStall=0,e.isDisposed||e._videoElement.currentTime!=t||(e._stalls++,e._setCanPlay(!1))},200)),e._canPlay||(t>e._settings.safeBufferSeconds?this._setCanPlay(!0):e.getTimeUntilUnderrun(n)>e._settings.safeBufferSeconds&&(e._videoElement.currentTime=Math.min(e._videoElement.currentTime+n,e._videoElement.duration),this._setCanPlay(!0))),this.raiseEvent(Dashling.Event.sessionStateChange,this._canPlay?this._videoElement.paused?g.paused:g.playing:g.buffering)},_allStreamsAppended:function(e,t){for(var n=!1,s=0;s<e.length;s++)n&=e[s].fragments[t]==_.appended;return n},_getDownloadCandidates:function(){var e=this,t=e._getCurrentFragmentRange(),n=[],s=0;if(t.start>-1){e._ensureStreamsUpdated(t);var i=e._getMissingFragmentIndex(t);if(i>=0){t.start=Math.max(t.start,i);for(var a=0;a<e._streams.length;a++){var r=e._streams[a];n.push(e._getDownloadableIndexes(r,t)),s+=n[n.length-1].length}}}return n.isAtMax=!s&&t.end>=0&&t.end<e._streams[0].fragments.length-1,n},_getCurrentFragmentRange:function(){var e=this,t=e._videoElement,n=e._settings.manifest.mediaDuration,s={start:-1,end:-1};if(n>0){var i=e._settings.startTime||t.currentTime,a=i+.005>=n,r=e._streams[0],o=r.fragments.length,d=r.fragments[0].time.lengthSeconds;a||(i>h&&(i-=h),s.start=Math.max(0,Math.min(o-1,Math.floor(i/d))),s.end=Math.max(0,Math.min(o-1,Math.ceil((i+e._settings.maxBufferSeconds)/d))))}return s},_ensureStreamsUpdated:function(e){for(var t=this,s=t._videoElement.currentTime,i=0;i<t._streams.length;i++){stream=t._streams[i],stream.assessQuality();for(var a=e.start;a<=e.end;a++)if(stream.isMissing(a,s)){var r=stream.fragments[a];n("Missing fragment reset: stream="+stream.streamType+" index="+a+" ["+r.time.startSeconds+"]",t._settings),stream.fragments[a].state=_.idle}}},_getMissingFragmentIndex:function(e){for(var t=this,n=e.start;n<=e.end;n++)for(var s=0;s<t._streams.length;s++){var i=t._streams[s].fragments[n];if(i.state<=_.idle)return n}return-1},_getDownloadableIndexes:function(e,t){for(var n=this,s=[],i=Math.min(t.end,t.start+n._settings.maxSegmentLeadCount[e.streamType]),a=n._settings.maxConcurrentRequests[e.streamType]-e.getActiveRequestCount(),r=t.start;s.length<a&&i>=r;r++)e.fragments[r].state<=_.idle&&s.push(r);return s},_setCanPlay:function(e){this._canPlay!==e&&(this._canPlay=e,this._onVideoRateChange())},_onVideoSeeking:function(){this._lastTimeBeforeSeek||(this._lastTimeBeforeSeek=this._lastCurrentTime),this._seekingTimerId&&clearTimeout(this._seekingTimerId),this._setCanPlay(!1),this._settings.startTime=0,this._seekingTimerId=setTimeout(this._onThrottledSeek,300)},_onThrottledSeek:function(){var e=this;if(!e.isDisposed){var t,s=e._videoElement.currentTime,i=(this._lastTimeBeforeSeek,Math.floor(Math.max(0,s-h)/e._streams[0].fragments[0].time.lengthSeconds)),a=1==e._videoElement.buffered.length&&e._videoElement.buffered.start(0)<=Math.max(0,s-2)&&e._videoElement.buffered.end(0)>s;if(n("Throttled seek: "+e._videoElement.currentTime,e._settings),e._seekingTimerId=0,e._lastTimeBeforeSeek=0,clearTimeout(e._nextRequestTimerId),e._nextRequestTimerId=0,e._appendIndex<i)for(t=0;t<e._streams.length;t++)e._streams[t].abortAll();if(e._settings.manifest.mediaDuration>e._settings.maxBufferSeconds&&!a)for(n("Clearing buffer",e._settings),t=0;t<e._streams.length;t++)e._streams[t].clearBuffer();e._appendIndex=i,e._appendNextFragment()}},_onVideoError:function(){var e,t=this._videoElement.error,n="VideoElementUnexpected";if(t){n=t.code;for(e in t)if(t[e]==n&&"code"!=e){n=e;break}}this.raiseEvent(Dashling.Event.sessionStateChange,g.error,n)},_onPauseStateChange:function(){this._adjustPlaybackMonitor(!this._videoElement.paused),this._checkCanPlay()},_onVideoEnded:function(){this.raiseEvent(u.sessionStateChange,g.paused)},_onVideoRateChange:function(){var e=this._canPlay?1:0;this._videoElement.playbackRate!=e&&(this._videoElement.playbackRate=this._videoElement.defaultPlaybackRate=e)}},e(Dashling.StreamController.prototype,l),e(Dashling.StreamController.prototype,d);var c="Dashling.Stream.bytesPerSecond";Dashling.Stream=function(t,n,s,i){function a(e){r.raiseEvent(u.download,e)}var r=this,o=i.manifest.streams[t];e(r,{fragments:[],streamType:t,qualityIndex:Math.max(0,Math.min(o.qualities.length-1,i.targetQuality[t])),_startTime:(new Date).getTime(),_appendLength:0,_appendTimeoutId:0,_initializedQualityIndex:-1,_initRequestManager:new Dashling.RequestManager(!1,i),_requestManager:new Dashling.RequestManager("video"==t,i),_mediaSource:n,_videoElement:s,_settings:i,_manifest:i.manifest,_streamInfo:o,_buffer:null,_hasInitializedBuffer:!1,_bufferRate:[],_initSegments:[]});for(var d=o.timeline.length,l=0;d>l;l++)r.fragments.push({state:_.idle,qualityIndex:-1,qualityId:"",requestType:"media",fragmentIndex:l,time:o.timeline[l],activeRequest:null,requests:[]});r._requestManager.addEventListener(u.download,a),r._initRequestManager.addEventListener(u.download,a)},Dashling.Stream.prototype={initialize:function(){var e=this._streamInfo.mimeType+";codecs="+this._streamInfo.codecs;if(!this._buffer)try{n("Creating "+e+" buffer",this._settings),this._buffer=this._mediaSource.addSourceBuffer(e)}catch(t){this.raiseEvent(u.sessionStateChange,g.error,m.sourceBufferInit,"type="+e+" error="+t)}},dispose:function(){this._requestManager&&this._requestManager.dispose(),this._initRequestManager&&this._initRequestManager.dispose(),this.clearAllThrottles(),this.removeAllEventListeners(),this.isDisposed=!0},abortAll:function(){this._requestManager.abortAll()},clearBuffer:function(){var e=this;clearTimeout(e._appendTimeoutId),this._isAppending=!1,this.abortAll();try{e._buffer.remove(0,e._videoElement.duration)}catch(t){}for(var n=0;n<e.fragments.length;n++){var s=e.fragments[n];s.state!==_.downloaded&&(s.state=_.idle)}},canAppend:function(e){var t=this.fragments[e],n=t?this._initSegments[t.qualityIndex]:null,s=this._initSegments[this._streamInfo.qualities.length-1];return t&&t.state==_.downloaded&&n&&n.state>=_.downloaded&&s&&s.state>=_.downloaded},append:function(e,t){function s(){if(!o.isDisposed)if(o._buffer.updating)o._appendTimeoutId=setTimeout(s,10);else{var l=f[0];if(f.length){h.addEventListener("update",i);try{n("Append started: "+o.streamType+" "+l.qualityId+" "+l.requestType+" "+(void 0!==l.fragmentIndex?"index "+l.fragmentIndex:""),o._settings),h.appendBuffer(l.data)}catch(u){a(m.sourceBufferAppendException,u)}}else o._appendTimeoutId=setTimeout(function(){if(!o.isDisposed)if(d.state=_.appended,o._isAppending=!1,o.isMissing(e,o._videoElement.currentTime))a(m.sourceBufferAppendMissing,"Buffer missing appended fragment");else{var n=((new Date).getTime()-o._startTime)/1e3;o._appendLength+=d.time.lengthSeconds,r(o._bufferRate,o._appendLength/n,5),t(d)}},30)}}function i(){if(!o.isDisposed){var e=f[0];h.removeEventListener("update",i),e.timeAtAppended=(new Date).getTime()-e.startTime,e.state=_.appended,e.clearDataAfterAppend&&(e.data=null),"init"===e.requestType&&(o._initializedQualityIndex=e.qualityIndex),n("Append complete: "+o.streamType+" "+e.qualityId+" "+e.requestType+" "+(void 0!==e.fragmentIndex?"index "+e.fragmentIndex:""),o._settings),f.shift(),s()}}function a(e,t){t=t||"";var s="error="+t+" (quality="+d.qualityId+(void 0!==d.fragmentIndex?" index="+d.fragmentIndex:"")+")";d.state=_.error,o._isAppending=!1,n("Append exception: "+s),o.raiseEvent(u.sessionStateChange,g.error,e,s)}var o=this,d=o.fragments[e],l=o._streamInfo.qualities.length-1,f=[],h=o._buffer;!o._isAppending&&d&&d.state===_.downloaded&&(o._isAppending=!0,d.state=_.appending,this._hasInitializedBuffer||(this._hasInitializedBuffer=!0,l>d.qualityIndex&&f.push(o._initSegments[l])),f.push(o._initSegments[d.qualityIndex]),f.push(d.activeRequest),s())},getBufferRate:function(){return this._bufferRate.average||0},getActiveRequestCount:function(){return this._requestManager.getActiveRequestCount()},getRequestStaggerTime:function(){return Math.round(1400*this._estimateDownloadSeconds(this.qualityIndex))},isMissing:function(e,t){var n=this.fragments[e];return n.state==_.appended&&!this.isBuffered(e,t)},isBuffered:function(e,t){var n=this.fragments[e],s=!1;if(n){var i=this._buffer.buffered,a=n.time,r=a.startSeconds<.3,o=a.startSeconds+a.lengthSeconds+.3>=this._manifest.mediaDuration,d=Math.max(t,a.startSeconds+(r?.8:.15)),l=a.startSeconds+a.lengthSeconds-(o?.8:.15);try{for(var u=0;u<i.length;u++)if(i.start(u)<=d&&i.end(u)>=l){s=!0;break}}catch(m){s=!0}}return s},canLoad:function(e){return this.fragments[e].state<=_.idle},load:function(e,t){function s(e){if(!a.isDisposed){r.state=_.downloaded;var s=Math.round(e.timeAtLastByte-(e.timeAtEstimatedFirstByte||e.timeAtFirstByte)),i=e.timeAtLastByte-s;n("Download complete: "+e.qualityId+" "+e.requestType+" index: "+e.fragmentIndex+" waiting: "+i+"ms receiving: "+s,a._settings),t(r)}}function i(e){a.isDisposed||(e.isAborted?(r.state=_.idle,r.activeRequest=null,r.requests=[]):(r.state=_.error,a.raiseEvent(u.sessionStateChange,g.error,m.mediaSegmentDownload,e.statusCode)))}var a=this,r=this.fragments[e];if(r&&r.state<=_.idle){r.state=_.downloading,r.qualityIndex=a.qualityIndex,r.qualityId=this._streamInfo.qualities[r.qualityIndex].id,a._loadInitSegment(this.qualityIndex,t);var o={url:a._getUrl(e,r),state:_.downloading,fragmentIndex:e,requestType:"media",qualityIndex:r.qualityIndex,qualityId:r.qualityId,clearDataAfterAppend:!0,isArrayBuffer:!0,onSuccess:s,onError:i};r.activeRequest=o,r.requests.push(o),n("Download started: "+o.qualityId+" "+o.requestType+" "+(void 0!==o.fragmentIndex?"index="+o.fragmentIndex:"")+" time="+((new Date).getTime()-a._startTime)+"ms stagger="+a.getRequestStaggerTime()+"ms",a._settings),a._requestManager.load(o)}},assessQuality:function(){var e=this,t=e._settings,s=e._requestManager.getAverageBytesPerSecond(),i=e._streamInfo.qualities.length-1;if(s?"video"===this.streamType&&localStorage.setItem(c,s):s=parseFloat(localStorage.getItem(c)),t.isABREnabled&&s)if(t.isRBREnabled)e.qualityIndex=Math.round(Math.random()*i);else{for(var a=0,r="Quality check "+e.streamType+": bps="+Math.round(s),o=e._streamInfo.timeline[0].lengthSeconds,d=.4*o,l=0;i>=l;l++){var u=e._estimateDownloadSeconds(l,0);r+=" "+l+"="+u.toFixed(2)+"s",o>u+d&&(a=l)}e.throttle(function(){n(r,e._settings)},"assess",1e3,!1,!1),e.qualityIndex=a}else e.qualityIndex=Math.min(e._streamInfo.qualities.length-1,t.targetQuality[e.streamType])},_estimateDownloadSeconds:function(e,t){var n=this,s=n._streamInfo.qualities[e],i=n._streamInfo.timeline[t||0].lengthSeconds,a=s.bandwidth/8,r=a*i,o=n._requestManager.getAverageBytesPerSecond();o?"video"===this.streamType&&localStorage.setItem(c,o):o=parseFloat(localStorage.getItem(c));var d=o||n._settings.defaultBandwidth;return r/d},_loadInitSegment:function(e,t){function s(){a.isDisposed||(o.state=_.downloaded,n("Download complete: "+a.streamType+" "+o.qualityId+" "+o.requestType+" "+(void 0!==o.fragmentIndex?"index "+o.fragmentIndex:""),a._settings),t(o))}function i(){a.isDisposed||(o.state=_.error,a.raiseEvent(u.sessionStateChange,g.error,m.initSegmentDownload,o.statusCode))}var a=this,r=this._streamInfo.qualities.length-1;if(e!=r&&a._loadInitSegment(r,t),!a._initSegments[e]){var o=a._initSegments[e]={url:this._getInitUrl(e),state:_.downloading,timeAtDownloadStarted:(new Date).getTime(),requestType:"init",qualityIndex:e,qualityId:this._streamInfo.qualities[e].id,isArrayBuffer:!0,onSuccess:s,onError:i};n("Download started: "+a.streamType+" "+o.qualityId+" "+o.requestType+" "+(void 0!==o.fragmentIndex?"index "+o.fragmentIndex:""),a._settings),a._initRequestManager.load(o)}},_getInitUrl:function(e){var t=this._streamInfo.initUrlFormat.replace("$RepresentationID$",this._streamInfo.qualities[e].id);return this._manifest.baseUrl+t},_getUrl:function(e,t){var n=this._streamInfo.fragUrlFormat.replace("$RepresentationID$",t.qualityId).replace("$Time$",t.time.start).replace("$Number$",t.time.serverSegmentIndex);return this._manifest.baseUrl+n}},e(Dashling.Stream.prototype,l),e(Dashling.Stream.prototype,d),Dashling.RequestManager=function(t,n){e(this,{_settings:n,_activeRequests:{},_retryTimeoutIds:{},_waitTimes:[],_receiveTimes:[],_bytesPerSeconds:[],_shouldRecordStats:t,_maxRetries:n.maxRetries,_delaysBetweenRetries:n.delaysBetweenRetries})};Dashling.RequestManager.prototype={_activeRequestCount:0,_totalRequests:0,_xhrType:XMLHttpRequest,dispose:function(){this.abortAll(),this.removeAllEventListeners()},getActiveRequestCount:function(){return this._activeRequestCount},abortAll:function(){for(var e in this._retryTimeoutIds)clearTimeout(e);for(var t in this._activeRequests){var s=this._activeRequests[t];n("Aborting request: "+s.url,this._settings),s.isAborted=!0,s.abort()}this._retryTimeoutIds={},this._activeRequests={}},load:function(e){function t(){function d(){0===l.status&&e.timeAtLastByte>=n._settings.requestTimeout&&(l.isTimedOut=!0),n._isRetriable(l)&&++i<s?(e.retryCount++,n._retryTimeoutIds[o]=setTimeout(t,a[Math.min(a.length-1,i)])):(e.state=_.error,e.hasError=!0,e.isAborted=l.isAborted,e.statusCode=l.isAborted?"aborted":l.isTimedOut?"timeout":l.status,e.onError&&e.onError(e))}delete n._retryTimeoutIds[o];var l=new n._xhrType;n._activeRequests[o]=l,n._activeRequestCount++,n._totalRequests++,l.url=e.url,l.open("GET",e.url,!0),e.isArrayBuffer&&(l.responseType="arraybuffer"),l.timeout=n._settings.requestTimeout,l.onreadystatechange=function(){l.readyState>0&&e.timeAtFirstByte<0&&(e.timeAtFirstByte=(new Date).getTime()-e.startTime)},l.onprogress=function(t){e.progressEvents.push({timeFromStart:(new Date).getTime()-e.startTime,bytesLoaded:t.lengthComputable?t.loaded:-1}),n._postProgress(e.progressEvents,!1)},l.onloadend=function(){if(delete n._activeRequests[o],n._activeRequestCount--,e.timeAtLastByte=(new Date).getTime()-e.startTime,l.status>=200&&l.status<=299){if(e.bytesLoaded=e.isArrayBuffer?l.response.byteLength:l.responseText?l.responseText.length:0,l.onreadystatechange(),n._postProgress(e.progressEvents,!0),e.progressEvents.length>2){var t=e.progressEvents[e.progressEvents.length-1],s=e.progressEvents[0],i=t.timeFromStart-s.timeFromStart,a=t.bytesLoaded-s.bytesLoaded;e.bytesPerMillisecond=a/i,e.timeAtFirstByte=e.timeAtLastByte-e.bytesLoaded/e.bytesPerMillisecond}e.data=e.isArrayBuffer?new Uint8Array(l.response):l.responseText,e.statusCode=l.status,e.state=_.downloaded,e.onSuccess&&e.onSuccess(e)}else d(e);e.timeAtLastByte>n._settings.requestCacheThreshold&&(r(n._waitTimes,e.timeAtFirstByte,20),r(n._receiveTimes,e.timeAtLastByte-e.timeAtFirstByte,20),n.raiseEvent(Dashling.Event.download,e))},e.state=_.downloading,e.progressEvents=[],e.timeAtFirstByte=-1,e.timeAtLastByte=-1,e.startTime=(new Date).getTime(),l.send()}var n=this,s=this._maxRetries,i=-1,a=this._delaysBetweenRetries,o=n._totalRequests+1;e.retryCount=0,t()},_isRetriable:function(e){return!e.isAborted&&404!=e.status},_postProgress:function(e,t){if(e.length>2){var n=e[e.length-1],s=e[0],i=n.bytesLoaded-s.bytesLoaded;if(i>1e4){var a=n.timeFromStart-s.timeFromStart;a>5&&(t||this._bytesPerSeconds.length<5)&&r(this._bytesPerSeconds,1e3*i/a,20)}}},getAverageWait:function(){return this._waitTimes.average||0},getAverageReceive:function(){return this._receiveTimes.average||0},getAverageBytesPerSecond:function(){return this._bytesPerSeconds.average||0}},e(Dashling.RequestManager.prototype,l)}();